name: Build Bindings

on:
  push:
    branches: [build]
  pull_request:
    branches: [build]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.binding }} - ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        arch: [x64, arm64]
        binding: [ffi, napi, python, lua]
        exclude:
          # Currently exclude ARM cross-builds for Python/Lua due to complex header dependencies
          # We can re-add them as we refine the cross-compilation environment
          - os: ubuntu-latest
            arch: arm64
            binding: python
          - os: ubuntu-latest
            arch: arm64
            binding: lua
          - os: windows-latest
            arch: arm64
            binding: python
          - os: windows-latest
            arch: arm64
            binding: lua

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ (matrix.os == 'ubuntu-latest' && matrix.arch == 'arm64' && 'aarch64-unknown-linux-gnu') || (matrix.os == 'windows-latest' && matrix.arch == 'arm64' && 'aarch64-pc-windows-msvc') || (matrix.os == 'macos-latest' && matrix.arch == 'arm64' && 'aarch64-apple-darwin') || (matrix.os == 'macos-latest' && matrix.arch == 'x64' && 'x86_64-apple-darwin') || (matrix.os == 'windows-latest' && matrix.arch == 'x64' && 'x86_64-pc-windows-msvc') || 'x86_64-unknown-linux-gnu' }}

      - name: Install Dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libwayland-dev libx11-dev libxkbcommon-dev libasound2-dev libdbus-1-dev libudev-dev libxcb-shape0-dev libxcb-xfixes0-dev
          if [ "${{ matrix.binding }}" == "lua" ]; then
            sudo apt-get install -y liblua5.4-dev
          fi
          if [ "${{ matrix.binding }}" == "python" ]; then
            sudo apt-get install -y python3-dev
          fi
          if [ "${{ matrix.arch }}" == "arm64" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu
          fi

      - name: Install Dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          if [ "${{ matrix.binding }}" == "lua" ]; then
            brew install lua
          fi

      - name: Setup Node.js (for N-API)
        if: matrix.binding == 'napi'
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Python (for PyO3)
        if: matrix.binding == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          architecture: ${{ (matrix.arch == 'arm64' && 'arm64') || 'x64' }}

      - name: Build
        shell: bash
        run: |
          # Determine target triple
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
            TARGET="${{ (matrix.arch == 'arm64' && 'aarch64-unknown-linux-gnu') || 'x86_64-unknown-linux-gnu' }}"
          elif [ "${{ matrix.os }}" == "windows-latest" ]; then
            TARGET="${{ (matrix.arch == 'arm64' && 'aarch64-pc-windows-msvc') || 'x86_64-pc-windows-msvc' }}"
          else
            TARGET="${{ (matrix.arch == 'arm64' && 'aarch64-apple-darwin') || 'x86_64-apple-darwin' }}"
          fi

          echo "Building for target: $TARGET with feature: ${{ matrix.binding }}"

          # Set Linker flags for macOS bindings
          if [[ "${{ matrix.os }}" == "macos-latest" ]]; then
            if [[ "${{ matrix.binding }}" == "python" || "${{ matrix.binding }}" == "lua" ]]; then
              export RUSTFLAGS="-C link-arg=-undefined -C link-arg=dynamic_lookup"
            fi
          fi

          # Use cross for Linux ARM64 cross-compilation
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.arch }}" == "arm64" ]]; then
            curl -L https://github.com/cross-rs/cross/releases/latest/download/cross-x86_64-unknown-linux-musl.tar.gz | tar xz -C /usr/local/bin
            
            # Create Cross.toml with a newer image and correct dependency installation
            echo '[target.aarch64-unknown-linux-gnu]' > Cross.toml
            echo 'image = "ghcr.io/cross-rs/aarch64-unknown-linux-gnu:edge"' >> Cross.toml
            echo 'pre-build = ["dpkg --add-architecture arm64 && apt-get update && apt-get install -y libudev-dev:arm64"]' >> Cross.toml
            
            export PKG_CONFIG_ALLOW_CROSS=1
            cross build --release --target $TARGET --no-default-features --features ${{ matrix.binding }}
          else
            # Normal build
            cargo build --release --target $TARGET --no-default-features --features ${{ matrix.binding }}
          fi

      - name: Prepare Artifact
        shell: bash
        run: |
          OS_NAME=""
          if [ "${{ matrix.os }}" == "windows-latest" ]; then OS_NAME="windows"; fi
          if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then OS_NAME="linux"; fi
          if [ "${{ matrix.os }}" == "macos-latest" ]; then OS_NAME="macos"; fi

          mkdir -p "dist/${OS_NAME}-${{ matrix.arch }}"

          # Find the resulting library
          EXTENSION=""
          if [ "${{ matrix.os }}" == "windows-latest" ]; then EXTENSION="dll"; else EXTENSION="so"; fi
          if [ "${{ matrix.os }}" == "macos-latest" ]; then EXTENSION="dylib"; fi

          # Target directory detection
          if [[ "${{ matrix.os }}" == "ubuntu-latest" && "${{ matrix.arch }}" == "arm64" ]]; then
            SEARCH_PATH="target/aarch64-unknown-linux-gnu/release"
          elif [ "${{ matrix.os }}" == "windows-latest" ]; then
            SEARCH_PATH="target/${{ (matrix.arch == 'arm64' && 'aarch64-pc-windows-msvc') || 'x86_64-pc-windows-msvc' }}/release"
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            SEARCH_PATH="target/${{ (matrix.arch == 'arm64' && 'aarch64-apple-darwin') || 'x86_64-apple-darwin' }}/release"
          else
            SEARCH_PATH="target/x86_64-unknown-linux-gnu/release"
          fi

          # Copy to specific subfolder
          cp ${SEARCH_PATH}/*.${EXTENSION} "dist/${OS_NAME}-${{ matrix.arch }}/" 2>/dev/null || cp target/release/*.${EXTENSION} "dist/${OS_NAME}-${{ matrix.arch }}/" 2>/dev/null || true

          # For N-API, rename to .node
          if [ "${{ matrix.binding }}" == "napi" ]; then
            find "dist/${OS_NAME}-${{ matrix.arch }}" -name "*.${EXTENSION}" -exec mv {} "dist/${OS_NAME}-${{ matrix.arch }}/vulfram_core.node" \;
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vulfram-tmp-${{ matrix.binding }}-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 1

  build-wasm:
    name: Build wasm32-unknown-unknown
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Build
        run: cargo build --release --target wasm32-unknown-unknown --no-default-features --features wasm

      - name: Prepare Artifact
        shell: bash
        run: |
          mkdir -p dist/wasm
          cp target/wasm32-unknown-unknown/release/*.wasm dist/wasm/ || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vulfram-wasm
          path: dist/wasm
          retention-days: 1

  merge:
    name: Merge Artifacts - ${{ matrix.binding }}
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        binding: [ffi, napi, python, lua]
    steps:
      - name: Download all temporary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: vulfram-tmp-${{ matrix.binding }}-*
          path: merged-dist/
          merge-multiple: true

      - name: Upload Unified Artifact
        uses: actions/upload-artifact@v4
        with:
          name: vulfram-${{ matrix.binding }}
          path: merged-dist/
